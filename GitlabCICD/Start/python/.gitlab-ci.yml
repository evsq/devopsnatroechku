# ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‚ÐµÐ¹Ð´Ð¶Ñ‹
stages:
  - test
  - build
  - deploy

# ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

# ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð´Ð¶Ð¾Ð±Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑŽÐ½Ð¸Ñ‚ Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¾Ð¹ Ðº ÑÑ‚ÐµÐ¹Ð´Ð¶Ñƒ test, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· python:3.11, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿Ð¸Ñ‚Ð¾Ð½Ð°/Ð¿Ð¸Ð¿, Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑŽ pip, ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ°Ð¼Ð¸ Ñ‚ÐµÑÑ‚Ñ‹ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ script. 
unit-tests:
  stage: test
  image: python:3.11
  script:
    - python --version
    - pip --version
    - pip install --upgrade pip
    - pip install -r requirements.txt  
    - echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐº unit-Ñ‚ÐµÑÑ‚Ð¾Ð²..."
    - pytest tests/ -v

# ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð´Ð¶Ð¾Ð±Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸ Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¾Ð¹ Ðº ÑÑ‚ÐµÐ¹Ð´Ð¶Ñƒ build, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· docker:24, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð¾ ÑÐ±Ð¾Ñ€ÐºÐµ Ð´Ð¾ÐºÐµÑ€ Ð¾Ð±Ñ€Ð°Ð·Ð° Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¿Ð¸ÑÐºÐ° Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ script.
build:
  stage: build
  image: docker:24  
  script:
    - echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð°..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE:latest .
    - docker images

# ÐžÐ¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð´Ð¶Ð¾Ð±Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¾Ð¹ Ðº ÑÑ‚ÐµÐ¹Ð´Ð¶Ñƒ deploy, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· alpine:latest, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¿Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² curl Ð¸ docker, Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸ÑŽ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° python-app-prod, Ð·Ð°Ð¿ÑƒÑÐºÑƒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° python-app-prod Ð¸ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼ Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸ÐµÐ¼ Ð² 10 ÑÐµÐº Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ script.
deploy:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl docker  
    - docker stop python-app-prod 2>/dev/null || true
    - docker rm python-app-prod 2>/dev/null || true
    - docker run -d --name python-app-prod $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - sleep 10
    - docker logs python-app-prod

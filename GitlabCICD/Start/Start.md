# –ß—Ç–æ —Ç–∞–∫–æ–µ GitLab CI/CD?
GitLab CI/CD ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã GitLab, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∞–∫—Ç–∏–∫ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (CI) –∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è/–¥–æ—Å—Ç–∞–≤–∫–∏ (CD), –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞—Ç—å –∫–æ–¥ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π.

–ë–ª–∞–≥–æ–¥–∞—Ä—è —Å–≤—è–∑–∫–µ GitLab + Gitlab CI/CD –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –≤ –æ–¥–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ - –æ—Ç –∫–æ–º–∏—Ç–∞ –¥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. 




# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ GitLab CI/CD
![Gitlab](./gitlab.jpeg)

–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- GitLab Server - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏ –∏ CI/CD
- GitLab Runner - –∞–≥–µ–Ω—Ç—ã, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–µ –¥–∂–æ–±—ã –≤ –ø–∞–π–ø–ª–∞–π–Ω–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ Executor (—Å—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∂–æ–±: Docker, Shell, Kubernetes)   
- .gitlab-ci.yml - —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞    

# –¢–µ–æ—Ä–∏—è

–ß—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å?
1. –§–∞–π–ª .gitlab-ci.yml ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ GitLab CI/CD
2. –í —ç—Ç–æ–º —Ñ–∞–π–ª–µ –º—ã –æ–ø–∏—Å—ã–≤–∞–µ–º –≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω: –∫–∞–∫–∏–µ –¥–∂–æ–±—ã –∑–∞–ø—É—Å–∫–∞–µ–º, –≤ –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö.
3. –°–∞–º –ø–∞–π–ø–ª–∞–π–Ω —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –æ–≥—Ä–æ–º–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∫–æ–¥–∞, –Ω–æ –≤ –¥–∞–Ω–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ç–æ–ª—å–∫–æ Stages, Jobs(images, script), Variables

–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç: 

Stages - —Å–ø–∏—Å–æ–∫ —ç—Ç–∞–ø–æ–≤ –ø–∞–π–ø–ª–∞–π–Ω–∞. –≠—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç –∑–∞–¥–∞—ë—Ç –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–π–¥–∂–µ–π. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–∂–æ–±—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç–µ–π–¥–∂–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –∞ —Å–∞–º–∏ —Å—Ç–µ–π–¥–∂—ã ‚Äî —Å—Ç—Ä–æ–≥–æ –¥—Ä—É–≥ –∑–∞ –¥—Ä—É–≥–æ–º. 

https://docs.gitlab.com/ci/yaml/#stages 

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –º—ã –æ–ø–∏—Å–∞–ª–∏ 3 —Å—Ç–µ–π–¥–∂–∞ - —Ç–µ—Å—Ç, —Å–±–æ—Ä–∫–∞, –¥–µ–ø–ª–æ–π.

```yaml
stages:
  - test
  - build
  - deploy
```


Jobs - –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤ —Å—Ç–µ–π–¥–∂–∞—Ö. –ö–∞–∂–¥–∞—è –¥–∂–æ–±–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–±–æ—Ä–∫—É, —Ç–µ—Å—Ç—ã, –¥–µ–ø–ª–æ–π) –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–≥–æ —Å—Ç–µ–π–¥–∂–∞.

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –º—ã –æ–ø–∏—Å–∞–ª–∏ –¥–∂–æ–±—É –∑–∞–ø—É—Å–∫–∞ —é–Ω–∏—Ç —Ç–µ—Å—Ç–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å—Ç–µ–π–¥–∂—É test, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑ python:3.11 –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤–µ—Ä—Å–∏–∏ –ø–∏—Ç–æ–Ω–∞/–ø–∏–ø, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é pip, —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ —Å–∞–º–∏ —Ç–µ—Å—Ç—ã –≤ —Ä–∞–∑–¥–µ–ª–µ script. –î–ª—è –¥–∂–æ–±—ã –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –Ω–æ —Ö–æ—Ä–æ—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π —Å—á–∏—Ç–∞–µ—Ç—Å—è —É–∫–∞–∑—ã–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ –º—ã –±—É–¥–µ–º –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∂–æ–±–µ - –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º —é–Ω–∏—Ç —Ç–µ—Å—Ç—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞–∑—ã–≤–∞–µ–º "unit-tests".
```yaml
unit-tests:
  stage: test
  image: python:3.11
  script:
    - python --version
    - pip --version
    - pip install --upgrade pip
    - pip install -r requirements.txt  
    - echo "üîÑ –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤..."
    - pytest tests/ -v
```

Variables - —Å–µ–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω—ã –∫–∞–∫ –≥—Ä—É–ø–ø–æ–≤—ã–µ, —Ç–∞–∫ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∂–æ–±—ã. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —Ç–∞–∫ –∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ/—Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ç–¥.

https://docs.gitlab.com/ci/yaml/#variables 


–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –º—ã –æ–±—ä—è–≤–∏–ª–∏ 3 –≥—Ä—É–ø–ø–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–º–∏ –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —É—á—Ç–µ–Ω—ã –≤–æ –≤—Å–µ—Ö –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö –¥–∂–æ–±–∞—Ö.
```yaml
variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
```

–ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞, —Å–æ—Å—Ç–æ—è—â–µ–≥–æ –∏–∑ 3—Ö —Å—Ç–µ–π–¥–∂–µ–π

```yaml
# –û–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–µ–π–¥–∂—ã
stages:
  - test
  - build
  - deploy

# –û–ø–∏—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
variables:
  DOCKER_HOST: unix:///var/run/docker.sock
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

# –û–ø–∏—Å—ã–≤–∞–µ–º –¥–∂–æ–±—É –∑–∞–ø—É—Å–∫–∞ —é–Ω–∏—Ç —Ç–µ—Å—Ç–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å—Ç–µ–π–¥–∂—É test, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑ python:3.11, –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –≤–µ—Ä—Å–∏–∏ –ø–∏—Ç–æ–Ω–∞/–ø–∏–ø, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é pip, —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∞–º–∏ —Ç–µ—Å—Ç—ã –≤ —Ä–∞–∑–¥–µ–ª–µ script. 
unit-tests:
  stage: test
  image: python:3.11
  script:
    - python --version
    - pip --version
    - pip install --upgrade pip
    - pip install -r requirements.txt  
    - echo "üîÑ –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤..."
    - pytest tests/ -v

# –û–ø–∏—Å—ã–≤–∞–µ–º –¥–∂–æ–±—É –∑–∞–ø—É—Å–∫–∞ —Å–±–æ—Ä–∫–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å—Ç–µ–π–¥–∂—É build, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑ docker:24, –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ —Å–±–æ—Ä–∫–µ –¥–æ–∫–µ—Ä –æ–±—Ä–∞–∑–∞ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –≤—ã–≤–æ–¥–∞ —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—É—â–∏—Ö –æ–±—Ä–∞–∑–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ script.
build:
  stage: build
  image: docker:24  
  script:
    - echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE:latest .
    - docker images

# –û–ø–∏—Å—ã–≤–∞–µ–º –¥–∂–æ–±—É –∑–∞–ø—É—Å–∫–∞ –¥–µ–ø–ª–æ—è —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å—Ç–µ–π–¥–∂—É deploy, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑ alpine:latest, –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–∞–∫–µ—Ç–æ–≤ curl –∏ docker, –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ —É–¥–∞–ª–µ–Ω–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ python-app-prod, –∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ python-app-prod –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ–º –≤ 10 —Å–µ–∫ –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ª–æ–≥–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ script.
deploy:
  stage: deploy
  image: alpine:latest
  script:
    - apk add --no-cache curl docker  
    - |
      echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ production..."
      docker stop python-app-prod 2>/dev/null || true
      docker rm python-app-prod 2>/dev/null || true
      docker run -d --name python-app-prod \
        $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - sleep 10
    - |
      docker logs python-app-prod
      echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
```


# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
   

# –ü—Ä–∞–∫—Ç–∏–∫–∞
1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Gitlab –∏ Gitlab Runner.
```bash
sudo vim /etc/hosts
# –¥–æ–±–∞–≤–ª—è–µ–º 127.0.0.1 gitlab.devopsnatroechku 

chmod +x setup.sh && bash setup.sh
```

2. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "python"
  - –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å http://gitlab.devopsnatroechku (–õ–æ–≥–∏–Ω: root, –ü–∞—Ä–æ–ª—å: Password123!)
  - –í –ª–µ–≤–æ–º —É–≥–ª—É –≤—ã–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª Projects, –¥–∞–ª–µ–µ Create a project -> Create blank project. –í –ø–æ–ª–µ "Project name" —É–∫–∞–∑—ã–≤–∞–µ–º python, –≤ –ø–æ–ª–µ "Project Url" –≤—ã–±–∏—Ä–∞–µ–º root –∏ —Å–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫—É —Å "Initialize repository with a README"

3. –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ä–µ–ø—É
```bash
cd python
git init --initial-branch=main
git remote add origin http://gitlab.devopsnatroechku/root/python.git
git add .
git commit -m "Initial commit"
git push --set-upstream origin main
```

4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
  - –í –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤—ã–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª Build –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª Pipelines
  - –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–∂–æ–±

5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–∞ —Ö–æ—Å—Ç–µ
```bash
docker ps -a
docker logs python-app-prod
docker images
```